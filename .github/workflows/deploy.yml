name: Deploy to Cloud Run

on:
  # Automatic deployments disabled - use manual deployment instead
  # push:
  #   branches: [ master ]
  #   paths-ignore:
  #     - '**.md'
  #     - 'docs/**'
  #     - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: 'false'
        type: boolean

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'nvidia-blog-agent' }}
  SERVICE_NAME: nvidia-blog-agent
  REGION: us-central1
  ARTIFACT_REGISTRY_REPO: nvidia-blog-agent

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-asyncio
    
    - name: Run tests
      run: |
        pytest -v --tb=short

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/master'
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
    
    - name: Set image tag
      id: image
      run: |
        IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
        echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "latest=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}:latest" >> $GITHUB_OUTPUT
    
    - name: Build and push Docker image
      run: |
        docker build -t ${{ steps.image.outputs.tag }} -t ${{ steps.image.outputs.latest }} .
        docker push ${{ steps.image.outputs.tag }}
        docker push ${{ steps.image.outputs.latest }}
    
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ steps.image.outputs.tag }} \
          --region ${{ env.REGION }} \
          --platform managed \
          --project ${{ env.PROJECT_ID }} \
          --allow-unauthenticated \
          --service-account nvidia-blog-agent-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
          --set-env-vars "GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }},USE_VERTEX_RAG=true,VERTEX_LOCATION=us-east5,RAG_DOCS_BUCKET=gs://nvidia-blog-rag-docs,STATE_PATH=gs://nvidia-blog-agent-state/state.json,GEMINI_MODEL_NAME=gemini-2.0-flash-001,GEMINI_LOCATION=us-east5" \
          --set-secrets "INGEST_API_KEY=ingest-api-key:latest,RAG_CORPUS_ID=rag-corpus-id:latest" \
          --memory 2Gi \
          --cpu 2 \
          --timeout 300 \
          --max-instances 10 \
          --min-instances 0
    
    - name: Get service URL
      id: service
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region ${{ env.REGION }} \
          --format='value(status.url)' \
          --project ${{ env.PROJECT_ID }})
        echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
        echo "Service deployed to: $SERVICE_URL"
    
    - name: Health check
      run: |
        sleep 10
        curl -f ${{ steps.service.outputs.url }}/health || exit 1

